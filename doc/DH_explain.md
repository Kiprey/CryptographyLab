# DH 协议

## 一、密钥协商

在 Client 和 Server 建立连接后，

1. Client 和 Server 建立自己的 RSA 公钥私钥，并生成自己的 DH 私钥，确定相同的 DH 公共参数 P 和 M。
2. 双方交换公钥
3. Client 使用 **Server 公钥**对**自己的DH公钥**进行加密，并将加密后的值发送给 Server。Server 使用自己的私钥进行解密，获取到 Client DH 公钥。
4. 之后 Server 重复 第三步，将自己的 DH 公钥以安全方式加密发送给 Client 并被对方解密获取。
5. 双方根据自己的 DH 私钥和对方的 DH 公钥，求出共享密钥。

## 二、消息收发

消息收发需要支持

- 消息完整性验证（md5）
- 消息来源验证（数字签名 RSA）

对于发送方而言，需要发送 $E(m)|Sig(H(m))$信息，以进行**消息签名**与**完整性验证**，同时保证**消息保密**。因此需要

- 使用共享密钥加密 m, 生成 E(m)
- 对明文 m 计算其哈希值 H(m)，并使用自己的 RSA 私钥对该 H(m) 进行签名，得到 Sig(H(m))
- 将上述两步的结果进行拼接得到待发送数据，并将其发送

对于接收方而言，接收方需要验证发送来的信息的可用性：

- 根据 RSA 密钥长度，将接收到的信息分为密文和签名两部分，并分别使用共享密钥和对方的公钥进行解密，得到 m' 和 H'(m)
- 使用得到的 m' 计算哈希值 H(m')，判断其值是否等于远程发来的 H'(m)，如果相同则说明消息可用，将其返回给上层应用程序。